<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Experiments - Ventriloquist Dummy</title>
    <style>
        #controls {position:relative;}
        #controls .right {position:absolute; left:400px; top:0}
    </style>
</head>
<body>
    <div id="controls">
        <div class="left">
            <button id="btnStart">Start</button> <button id="btnStop">Stop</button><br />
            <input type="range" id="mouthpos" value="0" min="0" max="100" step="1">
        </div>
        <div id="testMode" class="right">
            <button data-mode="normal">Normal</button>
            <button data-mode="drawing">Drawing (define new segment)</button>
            <button data-mode="dragging">Dragging (define new movement)</button>
        </div>
    </div>
    <canvas id="dummy"></canvas>
    <canvas id="testDummy"></canvas>
    <script src="../common/js/gumShield.js"></script>
    <script src="../common/js/chuckles.js"></script>
    <script>
        /*** Vars ***/

        var width = 400;
        var height = 500;

        /*** Drawing stuff ***/

        var canvas = document.getElementById('dummy');
        var ctx = canvas.getContext('2d');
        var testCanvas = document.getElementById('testDummy');
        var testCtx = canvas.getContext('2d');
        var mouthpos = document.getElementById('mouthpos');
        var audioCtx = new webkitAudioContext();
        var analyser = audioCtx.createAnalyser();
        var doDraw = true;
        var streamSrc;
        var byteData;
        var dummy, testDummy;

        function setup() {
            canvas.width = width;
            canvas.height = height;
            testCanvas.width = 640;
            testCanvas.height = 480;

            analyser.fftSize = 32; // Must be a power of 2, >= 32
            byteData = new Uint8Array(analyser.fftSize / 2);

            dummy = new Chuckles({
                canvas: canvas,
                image: '../common/img/chuck.jpg',
                movement: {x: -3, y: 30},
                steps: 4,
                fillStyle: '#000',
                path: [
                    ['moveTo', 108, 181],
                    ['lineTo',
                        [105, 214],
                        [107, 216],
                        [113, 219],
                        [125, 222],
                        [138, 222],
                        [151, 214],
                        [156, 209],
                        [160, 202],
                        [162, 197],
                        [167, 182],
                        [167, 177],
                        [158, 181]
                    ],
                    ['closePath']
                ]
            });
            testDummy = new Chuckles({
                canvas: 'testDummy',
                image: '../common/img/catimov.jpg',
                steps: 5,
                movement: {x: 20, y: 40}
            });

            document.getElementById('btnStart').addEventListener('click', startInput, false);
            document.getElementById('btnStop').addEventListener('click', stopInput, false);
            mouthpos.addEventListener('change', setMouthPos, false);
            document.getElementById('testMode').addEventListener('click', setMode, false);

            // setTimeout(startInput);
        }

        function setMouthPos() {
            var value = parseFloat(mouthpos.value) || 0;
            dummy.setPosition(value / 100);
            testDummy.setPosition(value / 100);
        }

        function setMode(e) {
            if (e.target.nodeName.toLowerCase() === 'button') {
                var mode = (e.target.dataset || {}).mode;
                if (mode) {
                    testDummy.setMode(mode);
                }
            }
        }

        function draw() {
            if (!doDraw) {
                return;
            }
            webkitRequestAnimationFrame(draw);

            analyser.getByteFrequencyData(byteData);
            var max = Math.max.apply(Math, byteData);
            dummy.setPosition(max / 256);
        }

        function startInput() {
            navigator.getUserMedia({audio: true}, function (stream) {
                streamSrc = audioCtx.createMediaStreamSource(stream);
                streamSrc.connect(analyser)
                doDraw = true;
                draw();
            }, function () {
                console.error('Oh noes!');
            });
        }

        function stopInput() {
            streamSrc = null;
            doDraw = false;
        }

        setup();
    </script>
</body>
</html>