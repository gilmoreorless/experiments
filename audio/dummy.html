<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Experiments - Ventriloquist Dummy</title>
    <link rel="stylesheet" href="../main.css">
    <style>
        body {background:#fff;}
        #controls {position:relative;}
        #controls .right {position:absolute; left:400px; top:0}
    </style>
</head>
<body class="centre">
    <div id="controls" class="controls">
        <div class="left">
            <div class="control-row">
                <button id="btnStart">Start Mic</button> <button id="btnStop">Stop Mic</button>
            </div>
            <div class="control-row">Mouth Pos: <input type="range" id="mouthpos" value="0" min="0" max="1" step="0.01"></div>
        </div>
        <div id="testMode" class="right">
            <button data-mode="normal">Normal</button>
            <button data-mode="drawing">Drawing (define new segment)</button>
            <button data-mode="dragging">Dragging (define new movement)</button>
        </div>
    </div>
    <canvas id="dummy"></canvas>
    <canvas id="testDummy"></canvas>
    <script src="../common/js/shimShiminy.js"></script>
    <script src="../common/js/chuckles.js"></script>
    <script>
        /*** Vars ***/

        var width = 210;
        var height = 270;
        var SHOW_TEST = false;

        /*** Drawing stuff ***/

        var canvas = document.getElementById('dummy');
        var ctx = canvas.getContext('2d');
        var testCanvas = document.getElementById('testDummy');
        var testCtx = canvas.getContext('2d');
        var mouthpos = document.getElementById('mouthpos');
        var audioCtx = new webkitAudioContext();
        var streamSrc, dummy, testDummy;

        function setup() {
            canvas.width = width;
            canvas.height = height;
            testCanvas.width = 640;
            testCanvas.height = 480;

            dummy = new Chuckles({
                canvas: canvas,
                image: '../common/img/chuck.jpg',
                movement: {x: -3, y: 30},
                steps: 4,
                fillStyle: '#000',
                path: [
                    ['moveTo', 108, 181],
                    ['lineTo',
                        [105, 214],
                        [107, 216],
                        [113, 219],
                        [125, 222],
                        [138, 222],
                        [151, 214],
                        [156, 209],
                        [160, 202],
                        [162, 197],
                        [167, 182],
                        [167, 177],
                        [158, 181]
                    ],
                    ['closePath']
                ]
            });
            dummy.bindInput(mouthpos);

            if (SHOW_TEST) {
                testDummy = new Chuckles({
                    canvas: 'testDummy',
                    image: '../common/img/catimov.jpg',
                    // steps: 5,
                    movement: {x: 20, y: 40}
                });
                testDummy.bindInput(mouthpos);
            }

            document.getElementById('btnStart').addEventListener('click', startInput, false);
            document.getElementById('btnStop').addEventListener('click', stopInput, false);
            if (SHOW_TEST) {
                document.getElementById('testMode').addEventListener('click', setMode, false);
            } else {
                document.getElementById('testMode').style.display = 'none';
                testCanvas.style.display = 'none';
            }
        }

        function setMode(e) {
            if (e.target.nodeName.toLowerCase() === 'button') {
                var mode = (e.target.dataset || {}).mode;
                if (mode) {
                    testDummy.setMode(mode);
                }
            }
        }

        function startInput() {
            navigator.getUserMedia({audio: true}, function (stream) {
                streamSrc = audioCtx.createMediaStreamSource(stream);
                dummy.bindInput(streamSrc);
            }, function () {
                console.error('Oh noes!');
            });
        }

        function stopInput() {
            dummy.unbindInput(streamSrc);
            streamSrc = null;
        }

        setup();
    </script>
</body>
</html>