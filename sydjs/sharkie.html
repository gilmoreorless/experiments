<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SydJS Demo - Sharkie</title>
    <link rel="stylesheet" href="../main.css">
    <style>
        #subject {float:left; margin-right:20px;}
        #controls h2 {font-size:140%; margin:20px 0 0 0;}
        #controls h2:first-child {margin:0;}
        #controls h2 + .control-row {margin-top:10px;}
    </style>
</head>
<body>
    <canvas id="subject"></canvas>
    <div id="controls" class="controls">
        <h2>Input</h2>
        <div class="control-row">
            <button id="btnStart">Start Mic</button> <button id="btnStop">Stop Mic</button>
        </div>
        <div class="control-row">Mouth Pos: <input type="range" id="mouthpos" value="0" min="0" max="1" step="0.01"></div>
        <h2>Display</h2>
        <div id="chuckles-mode" class="control-row">
            <div class="control-row"><button data-mode="normal" class="active">Normal</button></div>
            <div class="control-row"><button data-mode="drawing">Drawing (define new segment)</button></div>
            <div class="control-row"><button data-mode="dragging">Dragging (define new movement)</button></div>
        </div>
    </div>
    <script src="../common/js/shimShiminy.js"></script>
    <script src="../common/js/chuckles.js"></script>
    <script>
        /*** Vars ***/

        // var width = 640;
        // var height = 480;
        var width = 450;
        var height = 500;

        /*** Drawing stuff ***/

        var canvas = document.getElementById('subject');
        var ctx = canvas.getContext('2d');
        var mouthpos = document.getElementById('mouthpos');
        var modeButtons = document.querySelectorAll('#chuckles-mode button');
        var audioCtx = new webkitAudioContext();
        var streamSrc, dummy;

        function setup() {
            canvas.width = width;
            canvas.height = height;

            dummy = new Chuckles({
                canvas: canvas,
                image: '../common/img/mad.png',
                fillStyle: '#000',
                // steps: 5,
                movement: {x: 20, y: 40}
            });
            dummy.bindInput(mouthpos);

            document.getElementById('btnStart').addEventListener('click', startInput, false);
            document.getElementById('btnStop').addEventListener('click', stopInput, false);
            document.getElementById('chuckles-mode').addEventListener('click', setMode, false);
        }

        function setMode(e) {
            if (e.target.nodeName.toLowerCase() === 'button') {
                var mode = (e.target.dataset || {}).mode;
                if (mode) {
                    dummy.setMode(mode);
                    e.target.classList.add('active');
                    for (var i = 0, ii = modeButtons.length; i < ii; i++) {
                        if (modeButtons[i] !== e.target) {
                            modeButtons[i].classList.remove('active');
                        }
                    }
                }
            }
        }

        function startInput() {
            navigator.getUserMedia({audio: true}, function (stream) {
                streamSrc = audioCtx.createMediaStreamSource(stream);
                dummy.bindInput(streamSrc);
            }, function () {
                console.error('Oh noes!');
            });
        }

        function stopInput() {
            dummy.unbindInput(streamSrc);
            streamSrc = null;
        }

        setup();
    </script>
</body>
</html>