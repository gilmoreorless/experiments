<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Daylight savings time around the world</title>
    <link rel="stylesheet" href="../main.css">

    <style>
        body {
            margin-top: 0;
        }
        .controls {
            background: #fff;
            border-radius: 0 5px 5px 0;
            left: 0;
            position: fixed;
            text-align: left;
            top: 40px;
        }
        .controls label {
            display: block;
        }
        svg {
            display: block;
            margin: 0 auto;
        }
        text {
            font-size: 14px;
        }
        #titles-container {
            background: #D4E9F2;
            background: linear-gradient(to bottom, #D4E9F2 0, #D4E9F2 27px, rgba(0, 0, 0, 0) 100%);
            font-size: 12px;
            padding-top: 10px;
            position: fixed;
            width: 960px;
        }
        .month-name text {
            text-anchor: middle;
        }
        #zones-container {
            padding-top: 33px;
        }
        .changes rect {
            fill: hsl(20, 60%, 70%);
            stroke: none;
        }
        .changes .dst {
            fill: hsl(35, 100%, 70%);
            stroke: hsl(35, 50%, 20%);
            stroke-width: 1;
        }
        .changes .dst:hover {
            fill: hsl(35, 100%, 80%);
        }
        .gmt-offset text {
            font-size: 12px;
            font-family: monospace;
        }
        .month-line {
            stroke: rgba(0, 0, 0, 0.2);
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }
    </style>
</head>

<body class="centre">
<div id="controls" class="controls">
    Sort By:
    <label><input type="radio" name="sort" value="dstStart" checked> DST start date</label>
    <label><input type="radio" name="sort" value="offset"> GMT offset</label>
</div>
<div id="titles-container">
    <svg id="titles"></svg>
</div>
<div id="zones-container">
    <svg id="zones"></svg>
</div>

<script src="../common/js/d3.js"></script>
<script src="../common/js/underscore.js"></script>
<script src="../common/js/moment.js"></script>
<script src="../common/js/shimShiminy.js"></script>
<script>
function offsetNum(str) {
    var parts = str.split(':');
    var num = +parts[0];
    if (parts[1]) {
        var extra = +parts[1] / 60;
        num = num > 0 ? num + extra : num - extra;
    }
    return num;
}

function offsetStr(num) {
    var hours = num | 0;
    var mins = (num % 1) * 60;
    var str = hours < 0 ? '-' : '+';
    hours = Math.abs(hours);
    str += ('0' + hours).slice(-2);
    str += ':' + ('0' + mins).slice(-2);
    return str;
}

d3.json('moment-timezone.json', function (tzdata) {

    /*** Config ***/

    var labelPadding = 3;
    var labelHeight = 20;
    var labelWidth = 270;
    var yearWidth = 365;
    var gmtOffsetWidth = 80;

    /*** Data preparation ***/

    var zones = [];
    var rules = {};
    var year = new Date().getFullYear();

    _.each(tzdata.zones, function (data, id) {
        var zone = _.last(data);
        var info = zone.split(' ');
        var rule = info[1];
        var offset = offsetNum(info[0]);
        zones.push({
            id: id,
            offset: offset,
            offsetStr: offsetStr(offset),
            rule: rule
        });
        if (rule != '-') {
            rules[rule] = {
                name: rule,
                change: []
            };
        }
    });
    _.each(rules, function (data, name) {
        var rule = tzdata.rules[name];
        if (!rule) {
            console.error('NO RULE FOR ' + name);
        }
        // Special hard-coded 2013 case for crazy rules of Morocco
        if (name == 'Morocco') {
            rule = [
                "2013 2013 7 8 7 2 0 1 S",
                "2013 9999 9 0 8 3 0 0",
                "2012 2019 2 0 8 2 0 1 S",
                "2013 2013 6 9 7 3 0 0",
            ];
        }
        var i = rule.length;
        var info;
        while (i--) {
            info = rule[i].split(' ');
            if (info[1] == '9999' || name == 'Morocco') {
                data.change.push(_.rest(info, 2));
            }
        }
    });

    _.each(zones, function (zone) {
        var rule = rules[zone.rule];
        if (rule) {
            _.each(rule.change, function (change) {
                var month = +change[0];
                var day = +change[1];
                var saveParts = change[5].split(':');
                var save = +saveParts[0];
                if (saveParts.length > 1) {
                    save += (+saveParts[1] || 0) / 60;
                }
                var isDST = save > 0;
                var prop = isDST ? 'dstStart' : 'dstEnd';
                // Special case for Morocco again
                if (zone[prop]) {
                    prop += '2';
                }

                var date = moment([year, month, day || 1]);
                if (day === 0) { // "last Sunday of the month"
                    date = date.endOf('month').startOf('week');
                }
                zone[prop] = date;
                zone[prop + 'Value'] = [month, date.date(), save];
            });
        }

        var sortValue = 1300100; // mmdd1oo
        if (zone.dstStartValue) {
            sortValue = zone.dstStartValue[0] * 100000 +
                zone.dstStartValue[1] * 1000 + 100;
        }
        sortValue += zone.offset;
        zone.sortValue = sortValue;
    });
    zones = _.sortBy(zones, 'sortValue');
    // console.log(rules);
    // console.log(tzdata.rules);
    // console.log(zones);
    // var tmpZone = _.find(zones, function (z) { return z.id == 'Africa/Casablanca' })
    // console.log(tmpZone, rules[tmpZone.rule]);


    /*** Display ***/

    var sortMode = 'dstStart';

    var dateX = window.dateX = d3.scale.linear()
        .domain([1, 365])
        .range([1, yearWidth])

    var zoneY = function (d, i) {
        return 'translate(0,' + (i * (labelHeight + labelPadding) + labelPadding) + ')';
    }

    function dstPathBlock(x1, x2) {
        x1 = dateX(x1);
        x2 = dateX(x2);
        var path = [
            'M', x1, 0,
            'L', x2, 0,
                 x2, labelHeight,
                 x1, labelHeight,
            'z'
        ];
        return path;
    }

    function dstPath(suffix) {
        suffix || (suffix = '');
        var startProp = 'dstStart' + suffix;
        var endProp = 'dstEnd' + suffix;
        return function (d) {
            var startDay = d[startProp].dayOfYear();
            var endDay = d[endProp].dayOfYear();
            var path = [];

            if (endDay > startDay) {
                path = dstPathBlock(startDay, endDay);
            } else {
                path = dstPathBlock(startDay, 365).concat(dstPathBlock(0, endDay));
            }

            return path.join(' ');
        }
    }

    var titles = d3.select('#titles')
        .attr('width', labelWidth + yearWidth + gmtOffsetWidth)
        .attr('height', labelHeight + labelPadding)

    titles.append('text')
        .attr('y', labelHeight * .8)
        .text('Zone ID')
        .style('font-style', 'italic')

    var months = [];
    for (var m = 0; m < 12; m++) {
        months.push(moment([year, m, 1]));
    }

    titles.append('g')
        .attr('transform', 'translate(' + labelWidth + ',0)')
    .selectAll('.month-name')
        .data(months)
        .enter().append('g')
            .classed('month-name', true)
            .attr('transform', function (d) { return 'translate(' + dateX(d.dayOfYear()) + ',0)' })
            .append('text')
                .attr('y', labelHeight * .8)
                .text(function (d) { return d.format('MMM').substr(0, 1) })

    var svg = d3.select('#zones')
        .attr('width', labelWidth + yearWidth + gmtOffsetWidth)
        .attr('height', (labelHeight + labelPadding) * zones.length + labelPadding)

    var list = svg.selectAll('.zone-data')
        .data(zones)
        .enter().append('g')
            .classed('zone-data', true)
            .attr('transform', zoneY)

    list.append('g').classed('zone-id', true)
        .append('text')
            .attr('y', labelHeight * .8)
            .text(function (d) { return d.id });

    var changes = list.append('g')
        .classed('changes', true)
        .attr('transform', 'translate(' + labelWidth + ',0)')
    changes.append('rect')
        .attr('width', yearWidth)
        .attr('height', labelHeight)

    list.append('g')
        .classed('gmt-offset', true)
        .attr('transform', 'translate(' + (labelWidth + yearWidth + 10) + ',0)')
        .append('text')
            .attr('y', labelHeight * .8)
            .text(function (d) { return d.offsetStr })

    var dst = changes.filter(function (d) { return !!d.dstStart })

    dst.append('path')
        .classed('dst', true)
        .attr('d', dstPath())
        .attr('translate', 'transform(' + labelWidth + ',0)')
        // .text(function (d) {
        //     return ~~(d.sortValue / 1000)
        // })

    // YET MORE MOROCCO SPECIAL CODE
    dst.filter(function (d) { return d.id == 'Africa/Casablanca' }).append('path')
        .classed('dst', true)
        .attr('d', dstPath('2'))
        // .text(function (d) {
        //     var sortValue = d.dstStart2Value[0] * 100000 + d.dstStart2Value[1] * 1000 + 100;
        //     return ~~(sortValue / 1000);
        // })

    svg.selectAll('.month-line')
        .data(months)
        .enter().append('line')
            .classed('month-line', true)
            .attr('x1', 0).attr('x2', 0)
            .attr('y1', labelPadding).attr('y2', svg.attr('height') - labelPadding)
            .attr('transform', function (d) { return 'translate(' + (labelWidth + dateX(d.dayOfYear())) + ',0)' })

    function setSortMode(mode) {
        sortMode = mode;
        list.sort(function (a, b) {
            var prop = 'sortValue';
            if (sortMode === 'offset' && a.offset != b.offset) {
                prop = 'offset';
            }
            return a[prop] - b[prop];
        });
        moveZones();
    }

    function moveZones() {
        list.transition()
            .duration(1000)
            .attr('transform', zoneY)
    }

    /*** Interactive controls ***/

    document.getElementById('controls').addEventListener('change', function (e) {
        if (e.target.nodeName == 'INPUT') {
            setSortMode(e.target.value);
        }
    }, false)
});
</script>
</body>
</html>