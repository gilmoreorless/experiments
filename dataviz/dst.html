<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Daylight savings time around the world</title>
    <link rel="stylesheet" href="../main.css">

    <style>
        .changes rect {
            fill: hsl(20, 60%, 70%);
            stroke: none;
        }
        .changes .dst {
            fill: hsl(35, 100%, 70%);
            stroke: hsl(35, 50%, 20%);
            stroke-width: 1;
        }
        .changes .dst:hover {
            fill: hsl(35, 100%, 80%);
        }
    </style>
</head>

<body class="centre">
<svg id="zones"></svg>

<script src="../common/js/d3.js"></script>
<script src="../common/js/underscore.js"></script>
<script src="../common/js/moment.js"></script>
<script src="../common/js/shimShiminy.js"></script>
<script>
function offsetNum(str) {
    var parts = str.split(':');
    var num = +parts[0];
    if (parts[1]) {
        var extra = +parts[1] / 60;
        num = num > 0 ? num + extra : num - extra;
    }
    return num;
}

d3.json('tzinfo.json', function (tzdata) {

    /*** Config ***/

    var labelPadding = 3;
    var labelHeight = 20;
    var labelWidth = 250;
    var yearWidth = 365;
    var gmtOffsetWidth = 50;

    /*** Data preparation ***/

    var zones = [];
    var rules = {};

    _.each(tzdata.zones, function (data, id) {
        var zone = _.last(data);
        var info = zone.split(' ');
        var rule = info[1];
        zones.push({
            id: id,
            offset: offsetNum(info[0]),
            offsetStr: info[0],
            rule: rule
        });
        if (rule != '-') {
            rules[rule] = {
                name: rule,
                change: []
            };
        }
    });
    _.each(rules, function (data, name) {
        var rule = tzdata.rules[name];
        if (!rule) {
            console.error('NO RULE FOR ' + name);
        }
        // Special hard-coded 2013 case for crazy rules of Morocco
        if (name == 'Morocco') {
            rule = [
                "2012 2019 3 0 8 2 0 1 S",
                "2013 2013 6 9 7 3 0 0",
                "2013 2013 7 8 7 2 0 1 S",
                "2012 9999 8 0 8 3 0 0",
            ];
        }
        var i = rule.length;
        var info;
        while (i--) {
            info = rule[i].split(' ');
            if (info[1] != '9999' && name != 'Morocco') {
                break;
            }
            data.change.push(_.rest(info, 2));
        }
    });

    var year = new Date().getFullYear();
    _.each(zones, function (zone) {
        var rule = rules[zone.rule];
        if (rule) {
            _.each(rule.change, function (change) {
                var month = +change[0];
                var day = +change[1];
                var save = +change[5];
                var isDST = save > 0;
                var prop = isDST ? 'dstStart' : 'dstEnd';
                // Special case for Morocco again
                if (zone[prop]) {
                    prop += '2';
                }

                var date = moment([year, month, day || 1]);
                if (day === 0) { // "last Sunday of the month"
                    date = date.endOf('month').startOf('week');
                }
                zone[prop] = date;
                zone[prop + 'Value'] = [month, date.date(), save];
            });
        }

        var sortValue = 1300100; // mmdd1oo
        if (zone.dstStartValue) {
            sortValue = zone.dstStartValue[0] * 100000 +
                zone.dstStartValue[1] * 1000 + 100;
        }
        sortValue += zone.offset;
        zone.sortValue = sortValue;
    });
    zones = _.sortBy(zones, 'sortValue');
    // console.log(rules);
    // console.log(tzdata.rules);
    // console.log(zones);
    var tmpZone = _.find(zones, function (z) { return z.id == 'Africa/Casablanca' })
    console.log(tmpZone, rules[tmpZone.rule]);


    /*** Display ***/

    var dateX = window.dateX = d3.scale.linear()
        .domain([1, 365])
        .range([1, yearWidth])

    function dstPathBlock(x1, x2) {
        x1 = dateX(x1);
        x2 = dateX(x2);
        var path = [
            'M', x1, 0,
            'L', x2, 0,
                 x2, labelHeight,
                 x1, labelHeight,
            'z'
        ];
        return path;
    }

    function dstPath(suffix) {
        suffix || (suffix = '');
        var startProp = 'dstStart' + suffix;
        var endProp = 'dstEnd' + suffix;
        return function (d) {
            var startDay = d[startProp].dayOfYear();
            var endDay = d[endProp].dayOfYear();
            var path = [];

            if (endDay > startDay) {
                path = dstPathBlock(startDay, endDay);
            } else {
                path = dstPathBlock(startDay, 365).concat(dstPathBlock(0, endDay));
            }

            return path.join(' ');
        }
    }

    var list = d3.select('#zones')
        .attr('width', labelWidth + yearWidth + gmtOffsetWidth)
        .attr('height', (labelHeight + labelPadding) * zones.length)
        .selectAll('g')
        .data(zones)
        .enter().append('g')
            .classed('zone-data', true)
            .attr('transform', function (d, i) { return 'translate(0,' + (i * (labelHeight + labelPadding)) + ')' })

    list.append('g').classed('zone-id', true)
        .append('text')
            .attr('y', labelHeight)
            .text(function (d) { return d.id });

    var changes = list.append('g')
        .classed('changes', true)
        .attr('transform', 'translate(' + labelWidth + ',0)')
    changes.append('rect')
        .attr('width', yearWidth)
        .attr('height', labelHeight)

    list.append('g')
        .classed('gmt-offset', true)
        .attr('transform', 'translate(' + (labelWidth + yearWidth + 10) + ',0)')
        .append('text')
            .attr('y', labelHeight)
            .text(function (d) { return d.offset })

    var dst = changes.filter(function (d) { return !!d.dstStart })

    dst.append('path')
        .classed('dst', true)
        .attr('d', dstPath())
        .attr('translate', 'transform(' + labelWidth + ',0)')
        // .text(function (d) {
        //     return ~~(d.sortValue / 1000)
        // })

    // YET MORE MOROCCO SPECIAL CODE
    dst.filter(function (d) { return d.id == 'Africa/Casablanca' }).append('path')
        .classed('dst', true)
        .attr('d', dstPath('2'))
        // .text(function (d) {
        //     var sortValue = d.dstStart2Value[0] * 100000 + d.dstStart2Value[1] * 1000 + 100;
        //     return ~~(sortValue / 1000);
        // })
});
</script>
</body>
</html>